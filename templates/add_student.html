{% extends "base.html" %}

{% block title %}Add New Student{% endblock %}

{% block content %}
    <h1>Add New Student</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <form method="POST" action="{{ url_for('add_student') }}" enctype="multipart/form-data" class="form-container">
        {# Changed: form-grid is now INSIDE the form, on a new div #}
        <div class="form-grid"> 
            <div class="form-column">
                <label for="roll_no">Roll Number:</label>
                <input type="text" id="roll_no" name="roll_no" value="{{ request.form.get('roll_no', '') }}" required>

                <label for="name">Full Name:</label>
                <input type="text" id="name" name="name" value="{{ request.form.get('name', '') }}" required>

                <label for="branch">Branch:</label>
                <input type="text" id="branch" name="branch" value="{{ request.form.get('branch', '') }}" required>

                <label for="semester">Semester:</label>
                <input type="number" id="semester" name="semester" value="{{ request.form.get('semester', '') }}" min="1" max="10" required>

                <label for="admission_year">Year of Admission (e.g., 2023):</label>
                <input type="number" id="admission_year" name="admission_year" value="{{ request.form.get('admission_year', current_year) }}" min="1900" max="{{ current_year + 5 }}" required>

                <label for="subject">Subject (Optional):</label>
                <input type="text" id="subject" name="subject" value="{{ request.form.get('subject', '') }}">
            </div>

            <div class="form-column student-photo-upload">
                <h2>Student Photo</h2>
                <div class="radio-group">
                    <input type="radio" id="upload_file" name="photo_upload_method" value="file_upload" {% if request.form.get('photo_upload_method', 'file_upload') == 'file_upload' %}checked{% endif %}>
                    <label for="upload_file">Upload a clear photo</label>
                    <input type="radio" id="capture_camera" name="photo_upload_method" value="camera_capture" {% if request.form.get('photo_upload_method') == 'camera_capture' %}checked{% endif %}>
                    <label for="capture_camera">Capture from Camera</label>
                </div>

                <div id="file_upload_section">
                    <p>The photo must contain only one face.</p>
                    <input type="file" id="photo_file" name="photo_file" accept="image/jpeg, image/png">
                </div>

                <div id="camera_capture_section" style="display:none;">
                    <video id="camera_video" autoplay="true" playsinline></video>
                    <button type="button" id="capture_button" class="button-primary">Capture Photo</button>
                    <canvas id="camera_canvas" style="display:none;"></canvas>
                    <input type="hidden" id="photo_data" name="photo_data">
                    <p class="help-text">Captured photo will be used for recognition.</p>
                </div>
            </div>
        </div> {# End of form-grid div #}

        <button type="submit" class="button-green">Add Student to System</button>
        <a href="{{ url_for('view_students') }}" class="button-secondary">Cancel</a>
    </form>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        const uploadFileRadio = document.getElementById('upload_file');
        const captureCameraRadio = document.getElementById('capture_camera');

        const fileUploadSection = document.getElementById('file_upload_section');
        const cameraCaptureSection = document.getElementById('camera_capture_section');

        const cameraVideo = document.getElementById('camera_video');
        const captureButton = document.getElementById('capture_button');
        const cameraCanvas = document.getElementById('camera_canvas');
        const photoDataInput = document.getElementById('photo_data');

        let currentStream = null;

        function showSection(sectionId) {
            fileUploadSection.style.display = 'none';
            cameraCaptureSection.style.display = 'none';

            if (sectionId === 'file_upload_section') {
                fileUploadSection.style.display = 'block';
                stopCamera();
                photoDataInput.value = ''; // Clear captured data if switching away
            } else if (sectionId === 'camera_capture_section') {
                cameraCaptureSection.style.display = 'block';
                startCameraForCapture();
                // When switching to camera, make sure the file input is cleared
                document.getElementById('photo_file').value = ''; 
            }
        }

        // Event listeners for radio button changes
        uploadFileRadio.addEventListener('change', () => showSection('file_upload_section'));
        captureCameraRadio.addEventListener('change', () => showSection('camera_capture_section'));

        // Initial setup based on which radio is checked (defaults to 'file_upload')
        document.addEventListener('DOMContentLoaded', () => {
            if (captureCameraRadio.checked) {
                showSection('camera_capture_section');
            } else {
                showSection('file_upload_section'); // Default
            }
        });

        async function startCameraForCapture() {
            if (currentStream) { 
                stopCamera();
            }
            try {
                currentStream = await navigator.mediaDevices.getUserMedia({ video: { width: {ideal: 640}, height: {ideal: 480} } });
                cameraVideo.srcObject = currentStream;
            } catch (err) {
                console.error("Error accessing camera: ", err);
                alert("Could not access camera. Please ensure it's connected and permissions are granted.");
                captureCameraRadio.checked = false; 
                uploadFileRadio.checked = true; 
                showSection('file_upload_section'); 
            }
        }

        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                cameraVideo.srcObject = null;
                currentStream = null;
            }
        }

        captureButton.addEventListener('click', () => {
            if (currentStream) {
                cameraCanvas.width = cameraVideo.videoWidth;
                cameraCanvas.height = cameraVideo.videoHeight;
                cameraCanvas.getContext('2d').drawImage(cameraVideo, 0, 0, cameraCanvas.width, cameraCanvas.height);
                const imageData = cameraCanvas.toDataURL('image/jpeg', 0.8); 
                photoDataInput.value = imageData; 

                alert("Photo captured! You can now add the student.");
                stopCamera(); 
            } else {
                alert("Camera not active. Please ensure camera is enabled or try again.");
            }
        });

        window.addEventListener('beforeunload', stopCamera);

    </script>
{% endblock %}