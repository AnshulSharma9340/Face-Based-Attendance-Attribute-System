{% extends "layout.html" %}

{% block page_title %}Add New Professor{% endblock %}

{% block content %}
<div class="container mx-auto p-6 bg-white rounded-lg shadow-md mt-8">
    <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3">Add New Professor</h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="mb-4">
                {% for category, message in messages %}
                    <div class="p-3 rounded-md {% if category == 'success' %}bg-green-100 text-green-700{% elif category == 'danger' %}bg-red-100 text-red-700{% elif category == 'warning' %}bg-yellow-100 text-yellow-700{% else %}bg-blue-100 text-blue-700{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <form method="POST" action="{{ url_for('add_professor') }}" enctype="multipart/form-data" id="addProfessorForm" class="needs-validation" novalidate>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <div class="mb-4">
                    <label for="prof_id" class="block text-gray-700 text-sm font-bold mb-2">Professor ID:</label>
                    <input type="text" id="prof_id" name="prof_id" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="{{ request.form.prof_id }}" required pattern="^[A-Za-z0-9]+$" title="Alphanumeric characters only">
                </div>
                <div class="mb-4">
                    <label for="name" class="block text-gray-700 text-sm font-bold mb-2">Name:</label>
                    <input type="text" id="name" name="name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="{{ request.form.name }}" required pattern="^[A-Za-z\s]+$" title="Letters and spaces only">
                </div>
                <div class="mb-4">
                    <label for="department" class="block text-gray-700 text-sm font-bold mb-2">Department:</label>
                    <input type="text" id="department" name="department" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="{{ request.form.department }}" required>
                </div>
                <div class="mb-4">
                    <label for="email" class="block text-gray-700 text-sm font-bold mb-2">Email:</label>
                    <input type="email" id="email" name="email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="{{ request.form.email }}">
                </div>
                <div class="mb-4">
                    <label for="mobile" class="block text-gray-700 text-sm font-bold mb-2">Mobile:</label>
                    <input type="text" id="mobile" name="mobile" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="{{ request.form.mobile }}" pattern="^\d{10}$" title="10 digit mobile number">
                </div>
            </div>

            <div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Professor Photo:</label>
                    <div class="flex items-center justify-center border border-gray-300 rounded-lg p-2 mb-4 h-48 bg-gray-100 overflow-hidden">
                        <img id="photo-preview" src="#" alt="Photo Preview" class="max-w-full max-h-full object-contain hidden">
                        <span id="no-photo-text" class="text-gray-500">No Photo Selected</span>
                    </div>

                    <div class="flex space-x-2 mb-3">
                        <button type="button" id="upload-file-btn" class="flex-1 bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600">
                            Upload File
                        </button>
                        <button type="button" id="capture-camera-btn" class="flex-1 bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600">
                            Capture from Camera
                        </button>
                    </div>

                    <input type="file" id="photo_file" name="photo_file" accept="image/*" class="hidden">
                    <input type="hidden" id="photo_data_capture" name="photo_data_capture">
                    <input type="hidden" id="photo_upload_method" name="photo_upload_method" value="">

                    <div id="camera-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
                        <div class="bg-white p-6 rounded-lg shadow-xl relative">
                            <h3 class="text-xl font-bold mb-4">Capture Photo</h3>
                            <video id="camera-feed" class="w-96 h-72 bg-gray-200 rounded-md mb-4 object-cover"></video>
                            <canvas id="camera-canvas" class="hidden"></canvas>
                            <div class="flex justify-between">
                                <button type="button" id="capture-btn" class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600">
                                    Take Photo
                                </button>
                                <button type="button" id="cancel-capture-btn" class="bg-red-500 text-white py-2 px-4 rounded hover:bg-red-600">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="qualification" class="block text-gray-700 text-sm font-bold mb-2">Qualification:</label>
                    <input type="text" id="qualification" name="qualification" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="{{ request.form.qualification }}">
                </div>
                <div class="mb-4">
                    <label for="experience" class="block text-gray-700 text-sm font-bold mb-2">Experience:</label>
                    <input type="text" id="experience" name="experience" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="{{ request.form.experience }}">
                </div>
                <div class="mb-4">
                    <label for="achievements" class="block text-gray-700 text-sm font-bold mb-2">Achievements:</label>
                    <textarea id="achievements" name="achievements" rows="3" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">{{ request.form.achievements }}</textarea>
                </div>
                <div class="mb-4">
                    <label for="others" class="block text-gray-700 text-sm font-bold mb-2">Other Info:</label>
                    <textarea id="others" name="others" rows="3" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">{{ request.form.others }}</textarea>
                </div>
            </div>
        </div>

        <div class="flex items-center justify-between mt-6">
            <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                Add Professor
            </button>
            <a href="{{ url_for('view_professors') }}" class="inline-block align-baseline font-bold text-sm text-gray-600 hover:text-gray-800">
                Cancel
            </a>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const addProfessorForm = document.getElementById('addProfessorForm');
        const photoFileInput = document.getElementById('photo_file');
        const photoPreview = document.getElementById('photo-preview');
        const noPhotoText = document.getElementById('no-photo-text');
        const uploadFileBtn = document.getElementById('upload-file-btn');
        const captureCameraBtn = document.getElementById('capture-camera-btn');
        const photoUploadMethodInput = document.getElementById('photo_upload_method');

        const cameraModal = document.getElementById('camera-modal');
        const cameraFeed = document.getElementById('camera-feed');
        const cameraCanvas = document.getElementById('camera-canvas');
        const captureBtn = document.getElementById('capture-btn');
        const cancelCaptureBtn = document.getElementById('cancel-capture-btn');
        const photoDataCaptureInput = document.getElementById('photo_data_capture');

        let cameraStream = null; // To hold the media stream

        function showPhotoPreview(src) {
            photoPreview.src = src;
            photoPreview.classList.remove('hidden');
            noPhotoText.classList.add('hidden');
        }

        function clearPhotoPreview() {
            photoPreview.src = '#';
            photoPreview.classList.add('hidden');
            noPhotoText.classList.remove('hidden');
            photoDataCaptureInput.value = ''; // Clear hidden input for camera
            photoFileInput.value = ''; // Clear file input
            photoUploadMethodInput.value = ''; // Clear method selection
        }

        // --- File Upload Logic ---
        uploadFileBtn.addEventListener('click', () => {
            photoFileInput.click(); // Trigger file input click
        });

        photoFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    showPhotoPreview(e.target.result);
                    photoUploadMethodInput.value = 'file_upload'; // Set method
                    photoDataCaptureInput.value = ''; // Clear camera data if file is selected
                };
                reader.readAsDataURL(file);
            } else {
                clearPhotoPreview();
            }
        });

        // --- Camera Capture Logic ---
        captureCameraBtn.addEventListener('click', async () => {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
                cameraFeed.srcObject = cameraStream;
                cameraModal.classList.remove('hidden');
            } catch (err) {
                console.error("Error accessing camera for capture:", err);
                alert("Could not access camera. Please ensure permissions are granted and no other app is using it.");
            }
        });

        captureBtn.addEventListener('click', () => {
            if (cameraStream) {
                const context = cameraCanvas.getContext('2d');
                cameraCanvas.width = cameraFeed.videoWidth;
                cameraCanvas.height = cameraFeed.videoHeight;
                context.drawImage(cameraFeed, 0, 0, cameraCanvas.width, cameraCanvas.height);
                const dataUrl = cameraCanvas.toDataURL('image/jpeg', 0.9); // Get base64 JPEG
                
                showPhotoPreview(dataUrl);
                photoDataCaptureInput.value = dataUrl; // Store base64 data
                photoUploadMethodInput.value = 'camera_capture'; // Set method
                photoFileInput.value = ''; // Clear file input if camera is selected

                stopCameraStream();
                cameraModal.classList.add('hidden');
            }
        });

        cancelCaptureBtn.addEventListener('click', () => {
            stopCameraStream();
            cameraModal.classList.add('hidden');
        });

        function stopCameraStream() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
        }

        // --- Form Submission Logic ---
        addProfessorForm.addEventListener('submit', (event) => {
            // Validate that a photo method has been selected AND data exists for it
            if (photoUploadMethodInput.value === '') {
                alert("Please upload a photo or capture one from the camera.");
                event.preventDefault(); // Prevent form submission
                return;
            }

            if (photoUploadMethodInput.value === 'file_upload' && photoFileInput.files.length === 0) {
                 alert("Please select a photo file to upload.");
                 event.preventDefault();
                 return;
            }

            if (photoUploadMethodInput.value === 'camera_capture' && photoDataCaptureInput.value === '') {
                alert("Please capture a photo from the camera.");
                event.preventDefault();
                return;
            }
        });
    });
</script>
{% endblock %}